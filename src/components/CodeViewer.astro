---
export interface Props {
  title?: string;
  height?: string;
  html?: string;
  css?: string;
  js?: string;
  showCode?: boolean;
  defaultShowCode?: boolean;
  defaultTab?: 'html' | 'css' | 'js';
  enableMobileScroll?: boolean; // 新增：是否允许移动端内部滚动
}

const {
  title = 'Code Example',
  height = '400px',
  html = '',
  css = '',
  js = '',
  showCode = true,
  defaultShowCode = false,
  defaultTab = 'html',
  enableMobileScroll = true
} = Astro.props;

// 创建一个完整的HTML页面内容
const iframeContent = `<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        margin: 0;
        padding: 16px;
        font-family: sans-serif;
        /* 提升移动端滚动体验 */
        -webkit-overflow-scrolling: touch;
      }
      ${css}
    </style>
  </head>
  <body>
    ${html}
    ${js ? `<script>${js}</script>` : ''}
  </body>
</html>`;

// 使用 base64 编码来创建 data URL
const dataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(iframeContent)}`;

// 生成唯一ID
const id = Math.random().toString(36).substring(7);
---

<div class="code-viewer" data-viewer-id={id}>
  <div class="code-viewer-header">
    <h4>{title}</h4>
    {showCode && (
      <div class="code-viewer-controls">
        <button class="toggle-code-btn" aria-label="Toggle code">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M5.854 4.854a.5.5 0 1 0-.708-.708l-3.5 3.5a.5.5 0 0 0 0 .708l3.5 3.5a.5.5 0 0 0 .708-.708L2.707 8l3.147-3.146z"/>
            <path d="M10.146 4.854a.5.5 0 0 1 .708-.708l3.5 3.5a.5.5 0 0 1 0 .708l-3.5 3.5a.5.5 0 0 1-.708-.708L13.293 8l-3.147-3.146z"/>
            <path d="M8.5 2a.5.5 0 0 1 .5.5v11a.5.5 0 0 1-1 0v-11a.5.5 0 0 1 .5-.5z"/>
          </svg>
        </button>
      </div>
    )}
  </div>

  {showCode && (
    <div class="code-section" style={defaultShowCode ? "display: block;" : "display: none;"}>
      <div class="code-tabs">
        {html && <button class={`code-tab ${defaultTab === 'html' ? 'active' : ''}`} data-tab="html">HTML</button>}
        {css && <button class={`code-tab ${defaultTab === 'css' ? 'active' : ''}`} data-tab="css">CSS</button>}
        {js && <button class={`code-tab ${defaultTab === 'js' ? 'active' : ''}`} data-tab="js">JS</button>}
      </div>
      <div class="code-panels">
        {html && (
          <div class={`code-panel ${defaultTab === 'html' ? 'active' : ''}`} data-panel="html">
            <pre><code class="language-html">{html}</code></pre>
          </div>
        )}
        {css && (
          <div class={`code-panel ${defaultTab === 'css' ? 'active' : ''}`} data-panel="css">
            <pre><code class="language-css">{css}</code></pre>
          </div>
        )}
        {js && (
          <div class={`code-panel ${defaultTab === 'js' ? 'active' : ''}`} data-panel="js">
            <pre><code class="language-javascript">{js}</code></pre>
          </div>
        )}
      </div>
    </div>
  )}

  <div class="code-viewer-preview" data-enable-scroll={enableMobileScroll}>
    <iframe
      src={dataUrl}
      style={`height: ${height}; width: 100%; border: none;`}
      title={title}
      sandbox="allow-scripts"
      data-iframe-height={height}
    />
    {/* 移动端滚动提示层 */}
    <div class="mobile-scroll-overlay">
      <div class="scroll-hint">
        <span>双指滑动操作内部</span>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ id, defaultShowCode }}>
  // 等待 DOM 加载完成
  document.addEventListener('DOMContentLoaded', () => {
    const viewer = document.querySelector(`[data-viewer-id="${id}"]`);
    if (!viewer) return;

    const toggleBtn = viewer.querySelector('.toggle-code-btn');
    const codeSection = viewer.querySelector('.code-section');
    const codeTabs = viewer.querySelectorAll('.code-tab');
    const codePanels = viewer.querySelectorAll('.code-panel');
    const previewContainer = viewer.querySelector('.code-viewer-preview');
    const iframe = viewer.querySelector('iframe');
    const scrollOverlay = viewer.querySelector('.mobile-scroll-overlay');

    // 设置初始状态
    if (toggleBtn && defaultShowCode) {
      toggleBtn.classList.add('active');
    }

    // 切换代码显示
    if (toggleBtn && codeSection) {
      toggleBtn.addEventListener('click', () => {
        const isVisible = codeSection.style.display !== 'none';
        codeSection.style.display = isVisible ? 'none' : 'block';
        toggleBtn.classList.toggle('active', !isVisible);
      });
    }

    // 标签页切换
    codeTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;

        // 更新标签状态
        codeTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // 更新面板显示
        codePanels.forEach(panel => {
          if (panel.dataset.panel === tabName) {
            panel.classList.add('active');
          } else {
            panel.classList.remove('active');
          }
        });
      });
    });

    // 移动端滚动处理
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (isMobile && previewContainer && iframe) {
      let isIframeScrollable = false;
      let touchStartY = 0;
      let iframeInteractionEnabled = false;

      // 检测 iframe 是否可滚动
      const checkIframeScrollable = () => {
        try {
          const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
          const body = iframeDoc.body;
          const html = iframeDoc.documentElement;
          const scrollHeight = Math.max(body.scrollHeight, html.scrollHeight);
          const clientHeight = Math.max(body.clientHeight, html.clientHeight);
          isIframeScrollable = scrollHeight > clientHeight;
        } catch (e) {
          // 跨域 iframe 无法访问内容，假设可滚动
          isIframeScrollable = true;
        }
      };

      // iframe 加载完成后检测
      iframe.addEventListener('load', checkIframeScrollable);

      // 代码面板滚动边界检测
      const codePanelsContainer = viewer.querySelector('.code-panels');
      if (codePanelsContainer) {
        let startY = 0;
        let scrollTop = 0;

        codePanelsContainer.addEventListener('touchstart', (e) => {
          startY = e.touches[0].pageY;
          scrollTop = codePanelsContainer.scrollTop;
        }, { passive: true });

        codePanelsContainer.addEventListener('touchmove', (e) => {
          const deltaY = e.touches[0].pageY - startY;
          const isScrollingUp = deltaY > 0;
          const isScrollingDown = deltaY < 0;

          // 到达顶部边界且继续向上滑动
          if (isScrollingUp && scrollTop <= 0) {
            codePanelsContainer.style.overflow = 'hidden';
            setTimeout(() => {
              codePanelsContainer.style.overflow = 'auto';
            }, 100);
          }

          // 到达底部边界且继续向下滑动
          const maxScroll = codePanelsContainer.scrollHeight - codePanelsContainer.clientHeight;
          if (isScrollingDown && scrollTop >= maxScroll) {
            codePanelsContainer.style.overflow = 'hidden';
            setTimeout(() => {
              codePanelsContainer.style.overflow = 'auto';
            }, 100);
          }
        }, { passive: true });
      }

      // iframe 区域的手势处理
      let touchCount = 0;
      let hintTimer = null;

      // 监听触摸开始事件
      previewContainer.addEventListener('touchstart', (e) => {
        touchCount = e.touches.length;
        touchStartY = e.touches[0].pageY;

        // 如果是双指触摸，启用 iframe 内部滚动
        if (touchCount >= 2 && isIframeScrollable) {
          iframeInteractionEnabled = true;
          iframe.style.pointerEvents = 'auto';

          // 显示提示
          if (scrollOverlay) {
            scrollOverlay.classList.add('active');
            clearTimeout(hintTimer);
            hintTimer = setTimeout(() => {
              scrollOverlay.classList.remove('active');
            }, 1500);
          }
        }
      }, { passive: true });

      // 监听触摸结束事件
      previewContainer.addEventListener('touchend', (e) => {
        touchCount = e.touches.length;

        // 所有手指离开时，禁用 iframe 内部滚动
        if (touchCount === 0 && iframeInteractionEnabled) {
          setTimeout(() => {
            iframeInteractionEnabled = false;
            iframe.style.pointerEvents = '';
          }, 100);
        }
      }, { passive: true });

      // 单指滑动时阻止 iframe 接收事件
      previewContainer.addEventListener('touchmove', (e) => {
        if (!iframeInteractionEnabled && touchCount === 1) {
          iframe.style.pointerEvents = 'none';
        }
      }, { passive: true });
    }
  });
</script>

<style>
  .code-viewer {
    margin: 2rem 0;
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: 8px;
    overflow: hidden;
    background: white;
  }

  .code-viewer-header {
    padding: 0.75rem 1rem;
    background: var(--color-fill, #f9fafb);
    border-bottom: 1px solid var(--color-border, #e5e7eb);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .code-viewer-header h4 {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-muted, #6b7280);
  }

  .code-viewer-controls {
    display: flex;
    gap: 0.5rem;
  }

  .toggle-code-btn {
    padding: 0.25rem 0.5rem;
    background: transparent;
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--color-text-muted, #6b7280);
    transition: all 0.2s;
  }

  .toggle-code-btn:hover {
    background: var(--color-fill, #f3f4f6);
  }

  .toggle-code-btn.active {
    background: var(--color-accent, #3b82f6);
    color: white;
    border-color: var(--color-accent, #3b82f6);
  }

  .code-section {
    border-bottom: 1px solid var(--color-border, #e5e7eb);
  }

  .code-tabs {
    display: flex;
    gap: 0;
    padding: 0 1rem;
    background: var(--color-fill, #f9fafb);
    border-bottom: 1px solid var(--color-border, #e5e7eb);
  }

  .code-tab {
    padding: 0.5rem 1rem;
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--color-text-muted, #6b7280);
    transition: all 0.2s;
  }

  .code-tab:hover {
    color: var(--color-text, #111827);
  }

  .code-tab.active {
    color: var(--color-accent, #3b82f6);
    border-bottom-color: var(--color-accent, #3b82f6);
  }

  .code-panels {
    max-height: 300px;
    overflow-y: auto;
    background: var(--color-code-bg, #f9fafb);
    /* 优化移动端滚动 */
    -webkit-overflow-scrolling: touch;
    /* 防止滚动穿透 */
    overscroll-behavior: contain;
  }

  .code-panel {
    display: none;
    padding: 1rem;
  }

  .code-panel.active {
    display: block;
  }

  .code-panel pre {
    margin: 0;
    padding: 0;
    background: transparent;
    font-size: 0.875rem;
    line-height: 1.5;
    overflow-x: auto;
  }

  .code-panel code {
    font-family: 'Courier New', monospace;
    color: var(--color-text, #111827);
    background: transparent;
    padding: 0;
  }

  .code-viewer-preview {
    background: white;
    position: relative;
    /* 防止滚动穿透 */
    overscroll-behavior: contain;
  }

  .code-viewer iframe {
    display: block;
    /* 默认单指滑动时不响应 iframe 内部事件 */
    touch-action: pan-y;
  }

  /* 移动端滚动提示层 */
  .mobile-scroll-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10;
  }

  .mobile-scroll-overlay.active {
    display: flex;
    opacity: 1;
  }

  .scroll-hint {
    background: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    font-size: 0.875rem;
    color: var(--color-text, #111827);
  }

  /* 移动端特定样式 */
  @media (max-width: 768px) {
    .code-viewer-preview[data-enable-scroll="false"] iframe {
      pointer-events: none;
    }

    .code-viewer-preview {
      /* 在移动端优先响应页面滚动 */
      touch-action: pan-y;
    }

    .code-panels {
      /* 限制最大高度，避免占用过多屏幕 */
      max-height: 200px;
    }
  }

  @media (prefers-color-scheme: dark) {
    .code-viewer {
      background: #1f2937;
      border-color: #374151;
    }

    .code-viewer-header {
      background: #111827;
      border-color: #374151;
    }

    .code-viewer-header h4 {
      color: #9ca3af;
    }

    .toggle-code-btn {
      color: #9ca3af;
      border-color: #374151;
    }

    .toggle-code-btn:hover {
      background: #1f2937;
    }

    .toggle-code-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }

    .code-tabs {
      background: #111827;
      border-color: #374151;
    }

    .code-tab {
      color: #9ca3af;
    }

    .code-tab:hover {
      color: #e5e7eb;
    }

    .code-tab.active {
      color: #60a5fa;
      border-bottom-color: #60a5fa;
    }

    .code-panels {
      background: #1f2937;
    }

    .code-panel code {
      color: #e5e7eb;
    }

    .code-viewer-preview {
      background: #1f2937;
    }

    .scroll-hint {
      background: #374151;
      color: #e5e7eb;
    }

    .mobile-scroll-overlay {
      background: rgba(0, 0, 0, 0.7);
    }
  }

  /* Syntax highlighting */
  .language-html {
    color: #e34c26;
  }

  .language-css {
    color: #2965f1;
  }

  .language-javascript {
    color: #f0db4f;
  }

  @media (prefers-color-scheme: dark) {
    .language-html {
      color: #e8732c;
    }

    .language-css {
      color: #3b82f6;
    }

    .language-javascript {
      color: #f7df1e;
    }
  }
</style>